<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>IPTV Player Responsivo</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* [ ... estilos iguais ao anterior ... ] */
    body {
      margin: 0;
      font-family: sans-serif;
      background: #111;
      color: white;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    /* Mantenha os estilos anteriores... */
  </style>
</head>
<body>

  <header>
    <input type="text" id="urlInput" placeholder="Cole a URL da sua lista .m3u">
    <button onclick="loadFromURL()">Carregar</button>
    <input type="file" id="fileInput" accept=".m3u">
  </header>

  <div class="container">
    <div class="sidebar" id="groupList"></div>

    <div class="player-container">
      <video id="player" controls></video>

      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Buscar canal..." oninput="filterChannels()">
      </div>

      <div class="channel-navigator">
        <button onclick="changeChannel(-1)">Canal Anterior</button>
        <button onclick="changeChannel(1)">Pr처ximo Canal</button>
      </div>

      <div class="channel-navigator" id="channelList"></div>
    </div>
  </div>

  <script>
    let channels = [];
    let currentGroup = '';
    let groupChannels = [];
    let currentChannelIndex = -1;
    let hls;

    document.getElementById('fileInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function () {
        parseM3U(reader.result);
      };
      reader.readAsText(file);
    });

    async function loadFromURL() {
      const url = document.getElementById('urlInput').value;
      if (!url) return alert("Informe uma URL!");
      try {
        const res = await fetch(url);
        const text = await res.text();
        parseM3U(text);
      } catch (err) {
        alert("Erro ao carregar a lista: " + err);
      }
    }

    function parseM3U(content) {
      const lines = content.split('\n');
      let current = {};
      channels = [];

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line.startsWith('#EXTINF')) {
          const groupMatch = line.match(/group-title="(.*?)"/);
          const nameMatch = line.match(/,(.*)$/);
          current = {
            name: nameMatch ? nameMatch[1] : 'Sem nome',
            group: groupMatch ? groupMatch[1] : 'Sem grupo'
          };
        } else if (line.startsWith('http')) {
          current.url = line;
          channels.push({ ...current });
        }
      }

      renderGroups();
    }

    function renderGroups() {
      const groupList = document.getElementById('groupList');
      const uniqueGroups = [...new Set(channels.map(c => c.group))];
      groupList.innerHTML = '';
      uniqueGroups.forEach(group => {
        const btn = document.createElement('button');
        btn.textContent = group;
        btn.onclick = () => {
          currentGroup = group;
          renderChannels(group);
        };
        groupList.appendChild(btn);
      });

      if (uniqueGroups.length > 0) {
        currentGroup = uniqueGroups[0];
        renderChannels(currentGroup);
      }
    }

    function renderChannels(group) {
      groupChannels = channels.filter(c => c.group === group);
      document.getElementById('searchInput').value = "";
      displayChannels(groupChannels);
    }

    function displayChannels(list) {
      const channelList = document.getElementById('channelList');
      channelList.innerHTML = '';
      list.forEach((channel, index) => {
        const btn = document.createElement('button');
        btn.textContent = channel.name;
        btn.onclick = () => {
          currentChannelIndex = index;
          playChannel(channel.url);
        };
        channelList.appendChild(btn);
      });
    }

    function changeChannel(direction) {
      if (groupChannels.length === 0) return;
      currentChannelIndex += direction;
      if (currentChannelIndex < 0) currentChannelIndex = groupChannels.length - 1;
      if (currentChannelIndex >= groupChannels.length) currentChannelIndex = 0;
      playChannel(groupChannels[currentChannelIndex].url);
    }

    function filterChannels() {
      const input = document.getElementById('searchInput').value.toLowerCase();
      const filtered = groupChannels.filter(c => c.name.toLowerCase().includes(input));
      displayChannels(filtered);
    }

    function playChannel(url) {
      const video = document.getElementById('player');

      // Reset anterior
      if (hls) {
        hls.destroy();
        hls = null;
      }

      video.pause();
      video.removeAttribute('src');
      video.load();

      const tryWith = (sourceURL) => {
        if (Hls.isSupported()) {
          hls = new Hls();
          hls.loadSource(sourceURL);
          hls.attachMedia(video);

          const timeout = setTimeout(() => {
            if (video.paused) {
              hls.destroy();
              hls = null;
              if (!sourceURL.includes("corsproxy.io")) {
                tryWith("https://corsproxy.io/?" + encodeURIComponent(url));
              } else {
                alert("Erro: canal n찾o carregou ap처s 10 segundos.");
              }
            }
          }, 10000);

          video.onplay = () => clearTimeout(timeout);
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = sourceURL;
          video.play();
        } else {
          alert("Este navegador n찾o suporta HLS.");
        }
      };

      tryWith(url);
    }
  </script>
</body>
</html>
