
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IPTV - TiviMate Style (Grupos colapsáveis)</title>

<!-- Bootstrap apenas para utilitários e responsividade -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- HLS.js -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.1/dist/hls.min.js"></script>

<style>
  :root{
    --sidebar-w:320px;
    --bg:#0f0f10;
    --panel:#121214;
    --muted:#bfc3c6;
    --accent:#f0ad4e;
  }

  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,Segoe UI,Arial;}
  .app{display:flex;height:100vh;overflow:hidden}
  /* sidebar */
  .sidebar{width:var(--sidebar-w);background:#141416;border-right:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column}
  .sidebar .head{padding:18px 16px;border-bottom:1px solid rgba(255,255,255,0.03)}
  .sidebar .head h3{margin:0;font-weight:600;font-size:20px}
  .search-wrap{padding:10px 14px;border-bottom:1px solid rgba(255,255,255,0.03)}
  #search{width:100%;border-radius:6px;border:none;padding:10px;background:#0f0f10;color:var(--muted)}
  .groups{overflow:auto;padding:6px 6px 20px 6px}
  .group-item{padding:12px 12px;border-radius:6px;margin:6px 6px;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:space-between}
  .group-item:hover{background:rgba(255,255,255,0.02);color:#fff}
  .group-title{font-weight:600}
  .channels-list{margin:6px 0 12px 12px;list-style:none;padding:0;display:none}
  .channels-list li{display:flex;align-items:center;gap:10px;padding:8px;border-radius:6px;margin:4px 6px 4px 0;cursor:pointer;color:var(--muted)}
  .channels-list li:hover{background:rgba(255,255,255,0.02);color:#fff}
  .ch-logo{width:78px;height:48px;object-fit:cover;border-radius:4px;flex-shrink:0}
  .ch-meta{display:flex;flex-direction:column;min-width:0}
  .ch-name{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .ch-sub{font-size:12px;color:rgba(255,255,255,0.45);margin-top:3px}

  /* Main player area */
  .main{flex:1;display:flex;flex-direction:column}
  .tabs{background:#131315;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;gap:8px;padding:8px 12px;align-items:center}
  .tabs .tab{padding:8px 12px;border-radius:6px;color:var(--muted);cursor:pointer}
  .tabs .tab.active{background:rgba(255,255,255,0.02);color:#fff}
  .player-wrap{flex:1;display:flex;align-items:center;justify-content:center;position:relative;padding:12px}
  video#video{width:100%;height:100%;background:#000;border-radius:6px;outline:none;max-height:100%}
  .placeholder{position:absolute;left:60px;top:60px;color:var(--muted);font-size:18px;display:flex;align-items:center;gap:10px}
  .vod-grid{padding:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;overflow:auto}
  .vod-card{background:#111;border-radius:8px;padding:8px;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer}
  .vod-card img{width:140px;height:200px;object-fit:cover;border-radius:6px}
  .vod-title{font-size:14px;text-align:center;color:var(--muted)}
  /* responsive */
  @media (max-width:900px){
    .sidebar{width:240px}
    .ch-logo{width:64px;height:40px}
  }
  @media (max-width:700px){
    .sidebar{display:none}
  }
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="head">
      <h3>Buscar</h3>
    </div>

    <div class="search-wrap">
      <input id="search" placeholder="Buscar canal / VOD..." />
    </div>

    <div class="groups" id="groupsContainer">
      <!-- grupos serão inseridos aqui -->
      <div style="color:var(--muted);padding:12px">Carregando lista...</div>
    </div>
  </aside>

  <main class="main">
    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="tv">TV</div>
      <div class="tab" data-tab="vod">VOD</div>
    </div>

    <div class="player-wrap">
      <div class="placeholder" id="playerPlaceholder">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" style="opacity:0.9"><path d="M5 3v18l15-9L5 3z" fill="currentColor"/></svg>
        <div>Selecione um canal ou VOD para reproduzir</div>
      </div>
      <video id="video" controls playsinline></video>
    </div>

    <!-- VOD grid (aparece na aba VOD) -->
    <div id="vodSection" style="display:none">
      <div style="padding:12px;color:var(--muted);font-weight:600">VOD — selecione uma categoria na busca ou veja tudo</div>
      <div class="vod-grid" id="vodGrid"></div>
    </div>
  </main>
</div>

<script>
/* === CONFIG === */
const m3uUrl = 'https://tinyurl.com/2b4tc4de'; // sua lista
/* =========== */

let channels = []; // todos os itens lidos
let groupsMap = {}; // group -> [items]
let activeTab = 'tv';

/* Util: cria elemento com classes/texto */
function el(tag, cls='', txt=''){ const e=document.createElement(tag); if(cls) e.className=cls; if(txt) e.textContent=txt; return e; }

/* Carrega M3U e parse simplificado */
async function loadM3U(){
  try{
    const res = await fetch(m3uUrl, {cache:'no-store'});
    const text = await res.text();
    parseM3U(text);
    buildGroupsUI();
    renderVODGrid();
  }catch(err){
    const cont = document.getElementById('groupsContainer');
    cont.innerHTML = '<div style="padding:12px;color:#f66">Erro ao carregar a lista M3U.</div>';
    console.error(err);
  }
}

/* parse: extrai EXTINF linhas e o url seguinte */
function parseM3U(data){
  const lines = data.split(/\r?\n/);
  channels = [];
  for(let i=0;i<lines.length;i++){
    const l = lines[i].trim();
    if(!l) continue;
    if(l.startsWith('#EXTINF')){
      // nome
      const nameMatch = l.match(/tvg-name="([^"]+)"/);
      const name = (nameMatch && nameMatch[1]) ? nameMatch[1] : (l.split(',')[1] || 'Sem Nome');
      const groupMatch = l.match(/group-title="([^"]+)"/);
      const group = (groupMatch && groupMatch[1]) ? groupMatch[1] : 'Sem Grupo';
      const logoMatch = l.match(/tvg-logo="([^"]+)"/);
      const logo = (logoMatch && logoMatch[1]) ? logoMatch[1] : null;
      const url = (lines[i+1] && lines[i+1].trim()) ? lines[i+1].trim() : '';
      const isVOD = url.toLowerCase().includes('vod') || url.toLowerCase().includes('.mp4') || url.toLowerCase().includes('.mkv');
      let category = '';
      if(isVOD){
        const lower = name.toLowerCase();
        if(lower.includes('filme')||lower.includes('movie')) category='Filmes';
        else if(lower.includes('novela')||lower.includes('soap')) category='Novelas';
        else category='Mini Séries';
      }
      const item = { name: name.trim(), group, logo, url, isVOD, category };
      channels.push(item);
      i++; // pular url
    }
  }

  // montar mapa de grupos (só TV)
  groupsMap = {};
  channels.forEach(c=>{
    const key = c.group || 'Sem Grupo';
    if(!groupsMap[key]) groupsMap[key]=[];
    groupsMap[key].push(c);
  });
}

/* Constrói a UI dos grupos (apenas nomes visíveis inicialmente) */
function buildGroupsUI(filterQuery=''){
  const container = document.getElementById('groupsContainer');
  container.innerHTML = '';
  const groups = Object.keys(groupsMap).sort((a,b)=>a.localeCompare(b,'pt'));
  if(!groups.length){
    container.innerHTML = '<div style="padding:12px;color:var(--muted)">Nenhum grupo encontrado.</div>';
    return;
  }

  groups.forEach(group=>{
    // filtragem por query: se query existe, só exibe grupo se algum canal bater
    const groupItems = groupsMap[group].filter(c=> {
      if(!filterQuery) return true;
      const q = filterQuery.toLowerCase();
      return c.name.toLowerCase().includes(q) || group.toLowerCase().includes(q);
    });

    if(filterQuery && groupItems.length===0) return; // não mostra grupo sem correspondência

    const gWrap = el('div','group-wrap');
    const gItem = el('div','group-item');
    const title = el('div','group-title', group);
    const count = el('div','group-count', `(${groupItems.length})`);
    count.style.color='rgba(255,255,255,0.45)';
    gItem.appendChild(title);
    gItem.appendChild(count);
    gWrap.appendChild(gItem);

    // canais (oculto inicialmente)
    const chUl = el('ul','channels-list');
    // se temos filtro e há match, já expandimos
    if(filterQuery && groupItems.length>0) chUl.style.display='block';

    // popular canais (somente TV se aba TV ativa; mas aqui exibimos todos; a lógica de clique no tab oculta)
    groupItems.forEach(ch=>{
      // se estamos na aba TV, não incluir VOD; se aba vod, não incluir TV
      if(activeTab==='tv' && ch.isVOD) return;
      if(activeTab==='vod' && !ch.isVOD) return;

      const li = el('li');
      const img = document.createElement('img');
      img.className='ch-logo';
      img.loading='lazy';
      img.src = ch.logo || (ch.isVOD ? 'https://via.placeholder.com/140x200?text=VOD' : 'https://via.placeholder.com/80x50?text=Logo');
      img.alt = ch.name;
      const meta = el('div','ch-meta');
      const nm = el('div','ch-name', ch.name);
      const sub = el('div','ch-sub', ch.isVOD ? ch.category : group);
      meta.appendChild(nm);
      meta.appendChild(sub);
      li.appendChild(img);
      li.appendChild(meta);
      li.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        playChannel(ch.url, ch);
      });
      chUl.appendChild(li);
    });

    // comportamento clique: expande/colapsa
    gItem.addEventListener('click', ()=>{
      const currently = chUl.style.display;
      // fechar todos os outros lists
      document.querySelectorAll('.channels-list').forEach(u=>{ if(u!==chUl) u.style.display='none'; });
      chUl.style.display = (currently==='block') ? 'none' : 'block';
    });

    gWrap.appendChild(chUl);
    container.appendChild(gWrap);
  });

}

/* Play via Hls.js (compatível com .m3u8) */
let hlsInstance = null;
function playChannel(url, meta){
  const video = document.getElementById('video');
  document.getElementById('playerPlaceholder').style.display='none';
  if(!url){
    alert('URL do canal inválida.');
    return;
  }
  // destruir instância anterior
  if(hlsInstance){ try{ hlsInstance.destroy(); }catch(e){} hlsInstance=null; }
  if(Hls.isSupported()){
    hlsInstance = new Hls();
    hlsInstance.loadSource(url);
    hlsInstance.attachMedia(video);
    hlsInstance.on(Hls.Events.MANIFEST_PARSED, ()=> video.play().catch(()=>{}));
    hlsInstance.on(Hls.Events.ERROR, (ev,data)=>{
      console.warn('HLS error',data);
    });
  } else if(video.canPlayType('application/vnd.apple.mpegurl')){
    video.src = url;
    video.addEventListener('loadedmetadata', ()=> video.play().catch(()=>{}), {once:true});
  } else {
    alert('Seu navegador não suporta HLS.');
  }
  // opcional: destacar canal selecionado na UI (poderia implementar)
}

/* ABA switching */
document.querySelectorAll('.tabs .tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tabs .tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    activeTab = t.dataset.tab;
    // rebuild com a aba ativa (para excluir VOD em lista de TV)
    buildGroupsUI(document.getElementById('search').value.trim());
    // mostrar / ocultar seção VOD
    if(activeTab==='vod'){
      document.getElementById('vodSection').style.display='block';
      document.getElementById('groupsContainer').style.display='none';
    } else {
      document.getElementById('vodSection').style.display='none';
      document.getElementById('groupsContainer').style.display='block';
    }
  });
});

/* Busca: filtra grupos e canais. Se digitar, mostramos grupos que tem canais que batem e expandimos esses grupos. */
const searchEl = document.getElementById('search');
let searchTimer = null;
searchEl.addEventListener('input', ()=>{
  clearTimeout(searchTimer);
  searchTimer = setTimeout(()=>{
    const q = searchEl.value.trim();
    if(q===''){
      // rebuild default
      buildGroupsUI('');
      // se aba vod, atualizar grid
      if(activeTab==='vod') renderVODGrid('');
    } else {
      buildGroupsUI(q);
      if(activeTab==='vod') renderVODGrid(q);
    }
  },180);
});

/* VOD grid rendering (baseado em channels que são VOD) */
function renderVODGrid(filterQ=''){
  const grid = document.getElementById('vodGrid');
  grid.innerHTML = '';
  const vods = channels.filter(c=>c.isVOD && (!filterQ || c.name.toLowerCase().includes(filterQ.toLowerCase())));
  if(vods.length===0){
    grid.innerHTML = '<div style="color:var(--muted);padding:18px">Nenhum VOD encontrado.</div>';
    return;
  }
  vods.forEach(v=>{
    const card = el('div','vod-card');
    const img = document.createElement('img');
    img.loading='lazy';
    img.src = v.logo || 'https://via.placeholder.com/140x200?text=VOD';
    const title = el('div','vod-title', v.name);
    card.appendChild(img);
    card.appendChild(title);
    card.addEventListener('click', ()=> playChannel(v.url, v) );
    grid.appendChild(card);
  });
}

/* Inicializa */
loadM3U();

/* adapt: fechar todos lists ao clicar fora (útil) */
document.addEventListener('click', (e)=>{
  if(!e.target.closest('.group-wrap')) {
    // manter groups collapsed
    //document.querySelectorAll('.channels-list').forEach(u=>u.style.display='none');
  }
});
</script>
</body>
</html>
