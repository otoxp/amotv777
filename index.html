<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AMOTV777</title>

<link rel="stylesheet" href="style.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>

<body>

<div class="topbar">
  <div class="brand">
    <strong>AMOTV777</strong>
    <span>IPTV & EPG</span>
  </div>
</div>

<div class="app">

  <aside class="sidebar">
    <input id="search" placeholder="Buscar canal…">
    <div id="groups" class="groups"></div>
  </aside>

  <main class="player-wrap">
    <video id="video" controls playsinline></video>

    <div id="epg" class="epg-box">
      <div class="epg-title">Nenhum programa</div>
      <div class="epg-time"></div>
      <div class="epg-bar"><div class="epg-fill"></div></div>
    </div>

    <div id="channels" class="channel-list"></div>
  </main>

</div>

<script>
const M3U_URL = "https://tinyurl.com/w777tv";
const EPG_URL = "https://raw.githubusercontent.com/otoxp/wepg/refs/heads/main/guide3.xml";

let canais = [];
let grupos = {};
let epgMap = {};
let hls = null;

/* ================= M3U ================= */
fetch(M3U_URL).then(r=>r.text()).then(parseM3U);

function parseM3U(text){
  let lines = text.split("\n");
  let ch = {};
  lines.forEach(l=>{
    l=l.trim();
    if(l.startsWith("#EXTINF")){
      ch = {
        nome: l.split(",").pop().trim(),
        grupo: (l.match(/group-title="(.*?)"/)||[])[1] || "Outros",
        logo: (l.match(/tvg-logo="(.*?)"/)||[])[1] || "",
        id: (l.match(/tvg-id="(.*?)"/)||[])[1] || l.split(",").pop().trim()
      };
    }
    if(l.startsWith("http")){
      ch.url = l;
      canais.push(ch);
      ch = {};
    }
  });
  buildGroups();
  loadEPG();
  renderChannels();
}

/* ================= EPG ================= */
function loadEPG(){
  fetch(EPG_URL).then(r=>r.text()).then(xml=>{
    let dom = new DOMParser().parseFromString(xml,"text/xml");
    dom.querySelectorAll("programme").forEach(p=>{
      let id = p.getAttribute("channel");
      if(!epgMap[id]) epgMap[id]=[];
      epgMap[id].push({
        start: xmlDate(p.getAttribute("start")),
        stop: xmlDate(p.getAttribute("stop")),
        title: p.querySelector("title")?.textContent || "Sem título"
      });
    });
  });
}

function xmlDate(s){
  return new Date(
    s.substr(0,4),
    s.substr(4,2)-1,
    s.substr(6,2),
    s.substr(8,2),
    s.substr(10,2)
  );
}

/* ================= UI ================= */
function buildGroups(){
  grupos={};
  canais.forEach(c=>{
    if(!grupos[c.grupo]) grupos[c.grupo]=[];
    grupos[c.grupo].push(c);
  });

  let gdiv=document.getElementById("groups");
  gdiv.innerHTML="";
  Object.keys(grupos).forEach(g=>{
    let d=document.createElement("div");
    d.className="group";
    d.textContent=g;
    d.onclick=()=>renderChannels(g);
    gdiv.appendChild(d);
  });
}

function renderChannels(grupo){
  let list = grupo?grupos[grupo]:canais;
  let busca=document.getElementById("search").value.toLowerCase();
  let cdiv=document.getElementById("channels");
  cdiv.innerHTML="";
  list.filter(c=>c.nome.toLowerCase().includes(busca)).forEach(c=>{
    let d=document.createElement("div");
    d.className="channel";
    d.innerHTML=`<img src="${c.logo}"><span>${c.nome}</span>`;
    d.onclick=()=>play(c);
    cdiv.appendChild(d);
  });
}

document.getElementById("search").onkeyup=()=>renderChannels();

/* ================= PLAYER + EPG ================= */
function play(c){
  let v=document.getElementById("video");
  if(hls){hls.destroy();}
  if(Hls.isSupported()){
    hls=new Hls();
    hls.loadSource(c.url);
    hls.attachMedia(v);
    hls.on(Hls.Events.MANIFEST_PARSED,()=>v.play());
  } else {
    v.src=c.url;
    v.play();
  }
  showEPG(c);
}

function showEPG(c){
  let box=document.getElementById("epg");
  let title=box.querySelector(".epg-title");
  let time=box.querySelector(".epg-time");
  let fill=box.querySelector(".epg-fill");

  let now=new Date();
  let progs = epgMap[c.id] || epgMap[c.nome] || [];
  let p = progs.find(p=>now>=p.start && now<=p.stop);

  if(!p){
    title.textContent="Sem EPG disponível";
    time.textContent="";
    fill.style.width="0%";
    return;
  }

  let perc=((now-p.start)/(p.stop-p.start))*100;
  title.textContent=p.title;
  time.textContent=p.start.toLocaleTimeString().slice(0,5)+" - "+p.stop.toLocaleTimeString().slice(0,5);
  fill.style.width=perc+"%";
}
</script>
</body>
</html>
