<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AMOTV777 â€“ IPTV & EPG</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root {
    --bg-dark:#0f1117;
    --sidebar-dark:#111827;
    --accent:#2563eb;
    --card-bg:#1f2937;
}
*{box-sizing:border-box}
body{
    margin:0;
    font-family:'Inter',sans-serif;
    background:var(--bg-dark);
    color:#e5e5e5;
    display:flex;
    height:100vh;
    overflow:hidden;
}
#sidebar{
    width:260px;
    background:var(--sidebar-dark);
    padding:20px;
    overflow-y:auto;
    border-right:1px solid #374151;
}
#groupList{display:flex;flex-direction:column;gap:5px}
.groupBtn{
    background:rgba(255,255,255,.05);
    padding:10px;
    border-radius:6px;
    cursor:pointer;
    font-size:13px;
}
.groupBtn.active{background:var(--accent);color:#fff}

#main{flex:1;padding:15px;overflow-y:auto}

#playerBox{display:none;background:#000;border-radius:12px;margin-bottom:10px}
video{width:100%;aspect-ratio:16/9}

#epgBox{
    display:none;
    background:var(--card-bg);
    padding:15px;
    border-radius:10px;
    margin-bottom:15px;
    border-left:4px solid var(--accent);
}
.epg-now{font-weight:600}
.epg-time{font-size:12px;color:#94a3b8}
.epg-progress{height:6px;background:#374151;border-radius:3px;margin-top:8px}
.epg-fill{height:100%;background:var(--accent)}

#searchBox{
    width:100%;
    padding:12px;
    border-radius:8px;
    border:1px solid #4b5563;
    background:#111827;
    color:#fff;
    margin-bottom:15px;
}

.grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
    gap:12px;
}
.card{
    background:var(--card-bg);
    padding:12px;
    border-radius:12px;
    text-align:center;
    border:1px solid #374151;
}
.logo{height:50px;object-fit:contain;margin-bottom:6px}
.card h4{font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

button{
    background:var(--accent);
    color:#fff;
    padding:10px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    width:100%;
    font-weight:600;
}
</style>
</head>

<body>

<div id="sidebar">
    <h2 style="text-align:center;color:var(--accent)">AMOTV777</h2>
    <div id="groupList">Carregue uma lista...</div>
</div>

<div id="main">
    <div id="setupBox">
        <input id="urlInput" placeholder="URL da lista M3U" style="width:100%;padding:12px;margin-bottom:10px">
        <button onclick="loadFromURL()">Carregar</button>
        <input type="file" accept=".m3u,.m3u8" onchange="loadFromFile(event)" style="margin-top:10px">
    </div>

    <div id="playerBox">
        <video id="player" controls playsinline></video>
    </div>

    <div id="epgBox"></div>

    <input id="searchBox" placeholder="ðŸ” Buscar canal..." onkeyup="gerarGrid()">

    <div class="grid" id="canalGrid"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<script>
const EPG_URL = "https://raw.githubusercontent.com/otoxp/wepg/refs/heads/main/guide3.xml";

let canais=[], grupoAtual="Todos", hls=null;
let epgData={};

function normalizarId(txt){
    return (txt||"")
        .toLowerCase()
        .replace(/hd|fhd|uhd/g,'')
        .replace(/[^a-z0-9]/g,'')
        .trim();
}

async function loadFromURL(){
    const url=document.getElementById("urlInput").value.trim();
    if(!url)return;
    const r=await fetch(url);
    parseM3U(await r.text());
}

function loadFromFile(e){
    const reader=new FileReader();
    reader.onload=ev=>parseM3U(ev.target.result);
    reader.readAsText(e.target.files[0]);
}

async function parseM3U(text){
    canais=[];
    const lines=text.split("\n");
    let canal={};

    lines.forEach(l=>{
        l=l.trim();
        if(l.startsWith("#EXTINF")){
            const group=l.match(/group-title="(.*?)"/);
            const logo=l.match(/tvg-logo="(.*?)"/);
            const id=l.match(/tvg-id="(.*?)"/);
            const name=l.split(",")[1]||"Canal";
            canal={
                nome:name,
                grupo:group?.[1]||"Outros",
                logo:logo?.[1]||"",
                tvgId:id?.[1]||name
            };
        }else if(l.startsWith("http")){
            canal.url=l;
            canal.idx=canais.length;
            canais.push(canal);
            canal={};
        }
    });

    document.getElementById("setupBox").style.display="none";
    await loadEPG();
    gerarGrupos();
    gerarGrid();
}

async function loadEPG(){
    const r=await fetch(EPG_URL);
    const xml=new DOMParser().parseFromString(await r.text(),"text/xml");

    xml.querySelectorAll("programme").forEach(p=>{
        const key=normalizarId(p.getAttribute("channel"));
        if(!epgData[key]) epgData[key]=[];
        epgData[key].push({
            start:parseXmlDate(p.getAttribute("start")),
            stop:parseXmlDate(p.getAttribute("stop")),
            title:p.querySelector("title")?.textContent||"Sem tÃ­tulo"
        });
    });
}

function parseXmlDate(s){
    return new Date(Date.UTC(
        s.substr(0,4),
        s.substr(4,2)-1,
        s.substr(6,2),
        s.substr(8,2),
        s.substr(10,2)
    ));
}

function renderEPG(canal){
    const key=normalizarId(canal.tvgId||canal.nome);
    const progs=epgData[key]||[];
    const now=new Date();
    const atual=progs.find(p=>now>=p.start&&now<=p.stop);

    const box=document.getElementById("epgBox");
    if(!atual){box.style.display="none";return;}

    const perc=((now-atual.start)/(atual.stop-atual.start))*100;
    box.style.display="block";
    box.innerHTML=`
        <div class="epg-now">ðŸ“º No ar: ${atual.title}</div>
        <div class="epg-time">${format(atual.start)} - ${format(atual.stop)}</div>
        <div class="epg-progress"><div class="epg-fill" style="width:${perc}%"></div></div>
    `;
}

function format(d){
    return d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0');
}

function gerarGrupos(){
    const grupos=["Todos",...new Set(canais.map(c=>c.grupo))];
    const div=document.getElementById("groupList");
    div.innerHTML="";
    grupos.forEach(g=>{
        const b=document.createElement("div");
        b.className="groupBtn"+(g===grupoAtual?" active":"");
        b.innerText=g;
        b.onclick=()=>{grupoAtual=g;gerarGrupos();gerarGrid()};
        div.appendChild(b);
    });
}

function gerarGrid(){
    const grid=document.getElementById("canalGrid");
    const busca=document.getElementById("searchBox").value.toLowerCase();
    grid.innerHTML="";
    canais
    .filter(c=>(grupoAtual==="Todos"||c.grupo===grupoAtual)&&c.nome.toLowerCase().includes(busca))
    .forEach(c=>{
        grid.innerHTML+=`
            <div class="card">
                <img class="logo" src="${c.logo||'https://via.placeholder.com/100'}">
                <h4>${c.nome}</h4>
                <button onclick="playChannel(${c.idx})">ASSISTIR</button>
            </div>`;
    });
}

function playChannel(idx){
    const c=canais[idx];
    const v=document.getElementById("player");
    document.getElementById("playerBox").style.display="block";

    if(hls)hls.destroy();
    if(Hls.isSupported()){
        hls=new Hls();
        hls.loadSource(c.url);
        hls.attachMedia(v);
        hls.on(Hls.Events.MANIFEST_PARSED,()=>v.play());
    }else{
        v.src=c.url;
        v.play();
    }
    renderEPG(c);
    window.scrollTo({top:0,behavior:"smooth"});
}
</script>
</body>
</html>
