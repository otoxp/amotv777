
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Xtream Player M3U - Completo</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root {
            --bg-color: #0f0f0f;
            --sidebar-bg: #161616;
            --focus-color: #00ff88;
            --text-color: #eee;
            --card-bg: #222;
            --fav-gold: #ffcc00;
        }

        html, body {
            margin: 0; padding: 0;
            background-color: var(--bg-color); color: var(--text-color);
            font-family: sans-serif;
            height: 100dvh; overflow: hidden;
            display: flex; flex-direction: column;
            overscroll-behavior: none;
        }

        /* --- TELA DE LOGIN (CORRIGIDA) --- */
        #login-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; /* Z-index altíssimo para garantir que apareça */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box;
        }
        .login-box {
            background: #1e1e1e; padding: 30px; border-radius: 10px; width: 100%; max-width: 450px; text-align: center;
            border: 1px solid #333; box-shadow: 0 0 30px rgba(0,255,136,0.15);
        }
        input.m3u-input {
            width: 100%; padding: 15px; margin: 20px 0; background: #333; border: 1px solid #444; color: #fff; border-radius: 5px; box-sizing: border-box; font-size: 1rem;
        }
        button.btn-login {
            width: 100%; padding: 15px; background: var(--focus-color); border: none; font-weight: bold; font-size: 16px; border-radius: 5px; cursor: pointer; color: #000; transition: 0.2s;
        }
        button.btn-login:hover { transform: scale(1.02); background: #00cc6a; }

        /* --- ESTRUTURA PRINCIPAL --- */
        #container-master { display: flex; width: 100%; height: 100%; overflow: hidden; }

        #sidebar {
            width: 280px; background-color: var(--sidebar-bg); display: flex; flex-direction: column;
            border-right: 1px solid #333; z-index: 10; overflow-y: auto; -webkit-overflow-scrolling: touch; flex-shrink: 0;
        }

        .logout-btn {
            padding: 15px; background: #330000; color: #ff5555; text-align: center; cursor: pointer; border-bottom: 1px solid #333; font-weight: bold; font-size: 0.85rem;
        }
        .logout-btn:hover { background: #550000; }

        #main-content { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; position: relative; }

        #channel-grid {
            flex: 1; padding: 15px; overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); grid-gap: 15px; align-content: start;
            padding-bottom: 100px;
        }

        /* --- ITENS E EFEITOS VISUAIS --- */
        .category-item { padding: 15px; border-bottom: 1px solid #252525; cursor: pointer; font-size: 0.95rem; color: #bbb; transition: all 0.2s; }
        .category-item:hover { color: var(--focus-color); background: #222; padding-left: 20px; }
        .category-item.active { background: #222; color: var(--focus-color); font-weight: bold; border-left: 4px solid var(--focus-color); }
        .category-item[data-id="favorites"] { color: var(--fav-gold); }

        /* CARD COM EFEITO VERDE (HOVER) */
        .channel-card {
            background-color: var(--card-bg); border-radius: 8px; padding: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
            height: 120px; position: relative; border: 2px solid transparent; cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        
        /* O EFEITO MÁGICO */
        .channel-card:hover {
            transform: scale(1.08); 
            z-index: 100;
            background-color: #2a2a2a;
            border-color: var(--focus-color);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .channel-card img { width: 50px; height: 50px; margin-bottom: 8px; object-fit: contain; }
        .channel-name { font-size: 0.85rem; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .fav-star { position: absolute; top: 5px; right: 5px; font-size: 22px; color: #444; z-index: 5; transition: 0.2s; }
        .fav-star:hover { color: #fff; transform: scale(1.2); }
        .fav-star.is-active { color: var(--fav-gold); }

        /* PLAYER */
        #player-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: none; flex-direction: column;
        }
        video { width: 100%; height: 100%; background: #000; }
        #controls-bar { position: absolute; top: 15px; left: 15px; z-index: 2001; }
        button.btn-back { background: rgba(0,0,0,0.6); color: white; border: 1px solid white; padding: 10px 20px; border-radius: 30px; font-weight: bold; cursor: pointer; }
        button.btn-back:hover { background: var(--focus-color); color: #000; border-color: var(--focus-color); }

        /* LOADER */
        #loading {
            position: absolute; top:0; left:0; width:100%; height:100%; background: #121212; z-index: 5000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .spin { width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid var(--focus-color); border-radius: 50%; animation: s 1s linear infinite; }
        @keyframes s { to { transform: rotate(360deg); } }

        /* RESPONSIVO */
        @media (max-width: 768px) {
            #container-master { flex-direction: column; }
            #sidebar { width: 100%; height: 35%; border-right: none; border-bottom: 2px solid #333; }
            #main-content { height: 65%; }
            #channel-grid { grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; }
            .channel-card { height: 100px; }
            /* No celular removemos o hover exagerado */
            .channel-card:hover { transform: none; box-shadow: none; border-color: transparent; }
            .channel-card:active { border-color: var(--focus-color); background: #333; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--focus-color); margin-bottom:10px;">Xtream Web Player</h2>
            <p style="color:#aaa; font-size:0.9rem;">Insira o link M3U da sua lista:</p>
            
            <input type="text" id="m3u-url" class="m3u-input" placeholder="Cole seu link http://... aqui">
            
            <button class="btn-login" onclick="salvarELogar()">ACESSAR LISTA</button>
            
            <p style="color: #ff5555; font-size: 0.8rem; margin-top: 20px; line-height: 1.4;">
                Se ficar travado no carregamento, instale a extensão <b>"Allow CORS"</b> no seu navegador ou use um Proxy.
            </p>
        </div>
    </div>

    <div id="loading">
        <div class="spin"></div>
        <p style="margin-top:20px; color:#bbb; font-size:1.1rem;" id="loading-msg">Iniciando...</p>
    </div>

    <div id="player-overlay">
        <div id="controls-bar">
            <button class="btn-back" onclick="fecharPlayer()">VOLTAR</button>
        </div>
        <video id="video" controls playsinline></video>
    </div>

    <div id="container-master" style="display:none;">
        <div id="sidebar">
            <div class="logout-btn" onclick="sair()">&#10006; SAIR / TROCAR LISTA</div>
            <div id="category-list"></div>
        </div>
        <div id="main-content">
            <div id="channel-grid"></div>
        </div>
    </div>

    <script>
        // VARIAVEIS GLOBAIS
        let allChannels = [];
        let groupedChannels = {};
        let favorites = [];

        window.onload = function() {
            carregarFavoritos();
            verificarLogin();
        };

        // --- SISTEMA DE LOGIN ---
        function verificarLogin() {
            // Verifica se já existe um link salvo no navegador
            const savedUrl = localStorage.getItem('my_m3u_url_v2'); // Mudei a chave para limpar caches antigos
            
            if (savedUrl) {
                // Se tem link, esconde login e carrega a lista
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('container-master').style.display = 'flex';
                carregarLista(savedUrl);
            } else {
                // Se não tem link, mostra a tela de login
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('container-master').style.display = 'none';
            }
        }

        function salvarELogar() {
            const urlInput = document.getElementById('m3u-url');
            const url = urlInput.value.trim();
            
            if (!url) {
                alert("Por favor, cole um link válido!");
                return;
            }
            
            // Salva o link e recarrega a página para iniciar o processo
            localStorage.setItem('my_m3u_url_v2', url);
            location.reload();
        }

        function sair() {
            if(confirm("Deseja sair e remover a lista salva?")) {
                localStorage.removeItem('my_m3u_url_v2');
                location.reload();
            }
        }

        // --- PROCESSAMENTO DA LISTA (O CÉREBRO) ---
        async function carregarLista(url) {
            const loader = document.getElementById('loading');
            const msg = document.getElementById('loading-msg');
            
            loader.style.display = 'flex';
            msg.innerText = "Baixando lista M3U...";

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("Falha ao baixar arquivo");
                
                const text = await response.text();
                
                msg.innerText = "Lendo canais e grupos...";
                
                // Pequeno delay para a UI atualizar
                setTimeout(() => {
                    parseM3U(text);
                    renderCategorias();
                    loader.style.display = 'none';
                }, 100);

            } catch (error) {
                console.error(error);
                alert("Erro ao carregar a lista! Verifique se o link está correto ou se precisa de permissão CORS.");
                loader.style.display = 'none';
                // Volta para o login se der erro
                localStorage.removeItem('my_m3u_url_v2');
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('container-master').style.display = 'none';
            }
        }

        function parseM3U(content) {
            const lines = content.split('\n');
            allChannels = [];
            groupedChannels = {};
            let currentChannel = {};

            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                if (line.startsWith('#EXTINF:')) {
                    // Extrai Nome
                    const parts = line.split(',');
                    const name = parts[parts.length - 1].trim();
                    
                    // Extrai Logo
                    let logoMatch = line.match(/tvg-logo="([^"]*)"/);
                    let logo = logoMatch ? logoMatch[1] : "";
                    
                    // Extrai Grupo
                    let groupMatch = line.match(/group-title="([^"]*)"/);
                    let group = groupMatch ? groupMatch[1] : "Geral";

                    currentChannel = { name: name, logo: logo, group: group, url: "" };

                } else if (!line.startsWith('#')) {
                    // É a URL do vídeo
                    if (currentChannel.name) {
                        currentChannel.url = line;
                        
                        allChannels.push(currentChannel);
                        
                        if (!groupedChannels[currentChannel.group]) {
                            groupedChannels[currentChannel.group] = [];
                        }
                        groupedChannels[currentChannel.group].push(currentChannel);
                        
                        currentChannel = {}; // Reseta
                    }
                }
            }
        }

        // --- RENDERIZAÇÃO NA TELA ---
        function renderCategorias() {
            const list = document.getElementById('category-list');
            list.innerHTML = "";

            createCatBtn("★ FAVORITOS", "favorites", list);
            createCatBtn("TODOS OS CANAIS", "all", list);

            const groups = Object.keys(groupedChannels).sort();
            groups.forEach(group => {
                // Só mostra grupos que têm canais
                if(groupedChannels[group].length > 0) {
                    createCatBtn(group, group, list);
                }
            });
        }

        function createCatBtn(label, id, container) {
            let div = document.createElement('div');
            div.className = 'category-item';
            div.innerText = label;
            div.dataset.id = id;
            div.onclick = () => {
                document.querySelectorAll('.category-item').forEach(x => x.classList.remove('active'));
                div.classList.add('active');
                renderCanais(id);
            };
            container.appendChild(div);
        }

        function renderCanais(groupId) {
            const grid = document.getElementById('channel-grid');
            grid.innerHTML = "";
            grid.scrollTop = 0;

            let list = [];

            if (groupId === 'favorites') {
                list = allChannels.filter(ch => favorites.includes(ch.url));
                if(list.length === 0) grid.innerHTML = "<p style='width:100%; text-align:center; color:#777; margin-top:50px;'>Nenhum favorito salvo.</p>";
            } else if (groupId === 'all') {
                list = allChannels.slice(0, 150); // Limite de segurança para performance
            } else {
                list = groupedChannels[groupId] || [];
            }

            list.forEach(ch => {
                let isFav = favorites.includes(ch.url);
                let div = document.createElement('div');
                div.className = 'channel-card';
                
                let icon = ch.logo || 'https://cdn-icons-png.flaticon.com/512/777/777242.png';

                div.innerHTML = `
                    <div class="fav-star ${isFav?'is-active':''}" onclick="toggleFav(event, '${ch.url}')">${isFav?'★':'☆'}</div>
                    <img src="${icon}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/777/777242.png'">
                    <div class="channel-name">${ch.name}</div>
                `;
                
                div.onclick = (e) => {
                    if(!e.target.classList.contains('fav-star')) play(ch.url);
                };
                
                grid.appendChild(div);
            });
        }

        // --- FAVORITOS ---
        function carregarFavoritos() {
            let s = localStorage.getItem('iptv_m3u_favs');
            if(s) favorites = JSON.parse(s);
        }

        function toggleFav(e, url) {
            e.stopPropagation(); // Não abrir vídeo ao clicar na estrela
            let idx = favorites.indexOf(url);
            let el = e.target;
            
            if(idx === -1) {
                favorites.push(url);
                el.classList.add('is-active'); el.innerText = '★';
            } else {
                favorites.splice(idx, 1);
                el.classList.remove('is-active'); el.innerText = '☆';
            }
            localStorage.setItem('iptv_m3u_favs', JSON.stringify(favorites));
        }

        // --- PLAYER DE VÍDEO ---
        function play(url) {
            const ov = document.getElementById('player-overlay');
            const vid = document.getElementById('video');
            
            ov.style.display = 'flex';

            if(Hls.isSupported()) {
                if(window.hls) window.hls.destroy();
                window.hls = new Hls();
                window.hls.loadSource(url);
                window.hls.attachMedia(vid);
                window.hls.on(Hls.Events.MANIFEST_PARSED, () => vid.play());
            } else {
                vid.src = url;
                vid.play();
            }
        }

        function fecharPlayer() {
            const vid = document.getElementById('video');
            vid.pause();
            if(window.hls) window.hls.destroy();
            document.getElementById('player-overlay').style.display = 'none';
        }
    </script>
</body>
</html>
